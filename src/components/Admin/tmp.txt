const ResearchersTable = ({
  editable_columns,
  data,
  className = "",
  onRowClick,
  emptyStateMessage = "No data available",
  isLoading = false,
  adminType,
  history,
  originalColumnKeys,
  selectedColumns,
  refreshResearchers,
  updateStore,
  changeElement,
  onResearchersUpdate,
  ...props
}) => {
  const classes = useStyles()

  const [researcherSelected, setResearcherSelected] = useState(null)
  const [researchersSelected, setResearchersSelected] = useState([])
  const [activeButton, setActiveButton] = useState<string | null>(null)
  const [selectedRow, setSelectedRow] = useState<number | null>(null)
  const [selectedRows, setSelectedRows] = useState<number[]>([])
  const { enqueueSnackbar } = useSnackbar()
  const { t } = useTranslation()
  const [confirmationDialog, setConfirmationDialog] = useState(0)

  // Add new state for column selection
  const [anchorEl, setAnchorEl] = useState<null | HTMLElement>(null)
  const [menuPosition, setMenuPosition] = useState({ top: 0, left: 0 })

  const [editedData, setEditedData] = useState<{ [key: string]: any }>({})
  const [isEditing, setIsEditing] = useState(false)

  const [showCopyTooltip, setShowCopyTooltip] = useState(false)
  const [tooltipPosition, setTooltipPosition] = useState({ x: 0, y: 0 })

  const [editingResearcher, setEditingResearcher] = useState(null)
  const [filters, setFilters] = useState({})
  const [activeButtonTable, setActiveButtonTable] = useState({ id: null, action: null })
  const [confirmationDialogTable, setConfirmationDialogTable] = useState(false)
+ const [showPasswordDialog, setShowPasswordDialog] = useState(false)
+ const [updatedPassword, setUpdatedPassword] = useState("")
+ const [confirmPassword, setConfirmPassword] = useState("")
+ const [passwordError, setPasswordError] = useState("")
+ const [passwordDialogResearcher, setPasswordDialogResearcher] = useState(null)

  useEffect(() => {
    console.warn("Active button table changed:", activeButtonTable)
  }, [activeButtonTable])

  const columns: TableColumn[] = selectedColumns.map((col) => ({
    id: col.id,
    label: col.label,
    value: col.value,
    visible: true,
    sortable: col.sortable,
    filterable: true,
    filterType: "text",
  }))

  const renderCellContent = (column, row) => {
    const isEditable =
      editable_columns.includes(column.id) && activeButtonTable?.id === row.id && activeButtonTable?.action === "edit"
    if (!isEditable) {
      return (
        <div
          className={!activeButtonTable.action && column.id !== "loggedIn" ? classes.copyableCell : undefined}
          onClick={(e) => {
            if (!activeButtonTable.action && row[column.id] && column.id !== "loggedIn") {
              const textValue =
                typeof row[column.id] === "object" ? JSON.stringify(row[column.id]) : String(row[column.id])
              navigator.clipboard.writeText(textValue)
              setTooltipPosition({ x: e.clientX, y: e.clientY })
              setShowCopyTooltip(true)
              setTimeout(() => setShowCopyTooltip(false), 1000)
            }
          }}
        >
          {formatValue(row[column.id], column.id)}
        </div>
      )
    }
    const editKey = `${row.id}-${column.id}`
    const currentValue = editedData[editKey] !== undefined ? editedData[editKey] : row[column.id]

    return (
      <input
        type="text"
        value={currentValue ?? ""}
        onChange={(e) => setEditedData((prev) => ({ ...prev, [editKey]: e.target.value }))}
        className="w-full px-2 py-1 border border-blue-400 rounded focus:outline-none focus:ring-2 focus:ring-blue-500"
        onClick={(e) => e.stopPropagation()}
      />
    )
  }

- // Actions column
- const actions =
-   (row) => (
-     <TableActionsDiv
-       key={row.id + "-" + activeButtonTable.id + "-" + activeButtonTable.action}
-       row={row}
-       rowIndex={data.findIndex((r) => r.id === row.id)}
-       history={history}
-       setSelectedRow={setSelectedRow}
-       selectedRow={selectedRow}
-       setActiveButton={(abt) => {
-         console.warn("Setting active button from row:", row.id, "with row, action:", abt)
-         setActiveButtonTable({ id: abt.id, action: abt.action })
-       }}
-       activeButton={activeButtonTable}
-       researcherSelected={editingResearcher}
-       setResearcherSelected={setEditingResearcher}
-       changeElement={changeElement}
-       isEditing={!!editingResearcher && editingResearcher.id === row.id}
-       setIsEditing={() => setEditingResearcher(row)}
-       setEditedData={setEditedData}
-       handleSaveEdit={async () => {
-         // Save logic (similar to before)
-         try {
-           const rowEdits = {}
-           Object.entries(editedData).forEach(([key, value]) => {
-             if (key.startsWith(`${row.id}-`)) {
-               const columnKey = key.replace(`${row.id}-`, "")
-               rowEdits[columnKey] = value
-             }
-           })
-
-           const updatedResearcher = { ...row, ...rowEdits }
-           await LAMP.Researcher.update(row.id, updatedResearcher)
-           enqueueSnackbar("Successfully updated researcher", { variant: "success" })
-           const newEditedData = { ...editedData }
-           Object.keys(newEditedData).forEach((key) => {
-             if (key.startsWith(`${row.id}-`)) {
-               delete newEditedData[key]
-             }
-           })
-           setEditedData(newEditedData)
-           setEditingResearcher(null)
-           setActiveButtonTable({ id: null, action: null })
-           onResearchersUpdate([updatedResearcher])
-         } catch {
-           enqueueSnackbar("Failed to update researcher", { variant: "error" })
-         }
-       }}
-       handleSuspension={async () => {
-         // Suspend logic
-         try {
-           const updatedResearcher = {
-             ...row,
-             status: "SUSPENDED",
-             timestamps: {
-               ...row.timestamps,
-               suspendedAt: new Date().getTime(),
-             },
-           }
-
-           await LAMP.Researcher.update(row.id, {
-             ...updatedResearcher,
-           })
-           enqueueSnackbar("Suspended researcher", { variant: "success" })
-           setActiveButtonTable({ id: null, action: null })
-           onResearchersUpdate([updatedResearcher])
-         } catch {
-           enqueueSnackbar("Failed to suspend", { variant: "error" })
-         }
-       }}
-       handleUnSuspension={async () => {
-         // Unsuspend logic
-         try {
-           const updatedResearcher = {
-             ...row,
-             status: "ACTIVE",
-           }
-           await LAMP.Researcher.update(row.id, updatedResearcher)
-           enqueueSnackbar("Unsuspended researcher", { variant: "success" })
-           setActiveButtonTable({ id: null, action: null })
-           onResearchersUpdate([updatedResearcher])
-         } catch {
-           enqueueSnackbar("Failed to unsuspend", { variant: "error" })
-         }
-       }}
-       setConfirmationDialog={setConfirmationDialogTable}
-     />
-   )

+ // Inline actions function for CommonTable
+ const actions = (row) => {
+   const isSuspended = row.status === "SUSPENDED"
+   const isActive = (action) => activeButtonTable.id === row.id && activeButtonTable.action === action
+   const isEditing = editingResearcher?.id === row.id
+
+   const handleActionClick = async (buttonType) => {
+     setEditingResearcher(row)
+     setSelectedRow(data.findIndex((r) => r.id === row.id))
+
+     if (buttonType === "arrow_forward") {
+       history.push(`/researcher/${row.id}/studies`)
+     } else if (buttonType === "view") {
+       changeElement?.({ researcher: row, idx: data.findIndex((r) => r.id === row.id) })
+     } else if (buttonType === "save") {
+       // Save logic
+       try {
+         const rowEdits = {}
+         Object.entries(editedData).forEach(([key, value]) => {
+           if (key.startsWith(`${row.id}-`)) {
+             const columnKey = key.replace(`${row.id}-`, "")
+             rowEdits[columnKey] = value
+           }
+         })
+
+         const updatedResearcher = { ...row, ...rowEdits }
+         await LAMP.Researcher.update(row.id, updatedResearcher)
+         enqueueSnackbar("Successfully updated researcher", { variant: "success" })
+         const newEditedData = { ...editedData }
+         Object.keys(newEditedData).forEach((key) => {
+           if (key.startsWith(`${row.id}-`)) {
+             delete newEditedData[key]
+           }
+         })
+         setEditedData(newEditedData)
+         setEditingResearcher(null)
+         setActiveButtonTable({ id: null, action: null })
+         onResearchersUpdate([updatedResearcher])
+       } catch {
+         enqueueSnackbar("Failed to update researcher", { variant: "error" })
+       }
+     } else if (buttonType === "delete") {
+       setConfirmationDialogTable(true)
+     } else if (["edit", "suspend", "unsuspend"].includes(buttonType)) {
+       if (isActive(buttonType)) {
+         setActiveButtonTable({ id: null, action: null })
+         setEditingResearcher(null)
+       } else {
+         setActiveButtonTable({ id: row.id, action: buttonType })
+         if (buttonType === "suspend") {
+           // Handle suspend
+           try {
+             const updatedResearcher = {
+               ...row,
+               status: "SUSPENDED",
+               timestamps: {
+                 ...row.timestamps,
+                 suspendedAt: new Date().getTime(),
+               },
+             }
+
+             await LAMP.Researcher.update(row.id, updatedResearcher)
+             enqueueSnackbar("Suspended researcher", { variant: "success" })
+             setActiveButtonTable({ id: null, action: null })
+             onResearchersUpdate([updatedResearcher])
+           } catch {
+             enqueueSnackbar("Failed to suspend", { variant: "error" })
+           }
+         } else if (buttonType === "unsuspend") {
+           // Handle unsuspend
+           try {
+             const updatedResearcher = {
+               ...row,
+               status: "ACTIVE",
+             }
+             await LAMP.Researcher.update(row.id, updatedResearcher)
+             enqueueSnackbar("Unsuspended researcher", { variant: "success" })
+             setActiveButtonTable({ id: null, action: null })
+             onResearchersUpdate([updatedResearcher])
+           } catch {
+             enqueueSnackbar("Failed to unsuspend", { variant: "error" })
+           }
+         }
+       }
+     } else if (buttonType === "passwordEdit") {
+       setPasswordDialogResearcher(row)
+       setShowPasswordDialog(true)
+       setUpdatedPassword("")
+       setConfirmPassword("")
+       setPasswordError("")
+     }
+   }
+
+   return (
+     <div className="table-actions-container">
+       {/* Visualize Researcher */}
+       <div className="table-actions-icon-container" onClick={() => handleActionClick("arrow_forward")}>
+         <VisualizeResearcher className="table-actions-icon" style={{ transform: "scaleX(-1)" }} />
+       </div>
+
+       {/* View Researcher */}
+       <div className="table-actions-icon-container" onClick={() => handleActionClick("view")}>
+         <ViewResearcher className="table-actions-icon" />
+       </div>
+
+       {/* Edit Researcher */}
+       <div
+         className={`table-actions-icon-container ${isActive("edit") ? "active" : ""}`}
+         onClick={() => handleActionClick("edit")}
+       >
+         <Edit className="table-actions-icon" />
+       </div>
+
+       {/* Save Researcher */}
+       <div
+         className={`table-actions-icon-container ${isEditing ? "" : "disabled-icon-container"}`}
+         onClick={() => (isEditing ? handleActionClick("save") : null)}
+       >
+         <Save className={`table-actions-icon ${isEditing ? "" : "disabled-icon"}`} />
+       </div>
+
+       {/* Password Edit */}
+       <div className="table-actions-icon-container">
+         <PasswordEdit className="table-actions-icon" onClick={() => handleActionClick("passwordEdit")} />
+       </div>
+
+       {/* Suspend/Unsuspend Researcher */}
+       <div
+         className="table-actions-icon-container"
+         onClick={() => handleActionClick(isSuspended ? "unsuspend" : "suspend")}
+       >
+         {isSuspended ? <UnSuspend className="table-actions-icon" /> : <Suspend className="table-actions-icon" />}
+       </div>
+
+       {/* Delete Researcher */}
+       <div
+         className={`table-actions-icon-container ${isActive("delete") ? "active" : ""}`}
+         onClick={() => handleActionClick("delete")}
+       >
+         <Delete className="table-actions-icon" />
+       </div>
+     </div>
+   )
+ }
+
+ // Password dialog handlers
+ const handleSubmitPassword = async () => {
+   try {
+     if (updatedPassword !== confirmPassword) {
+       setPasswordError("Passwords do not match")
+       return
+     }
+
+     console.log("IN THE UPDATED PASSWORD", confirmPassword)
+
+     try {
+       console.log("Attempting to update credential...")
+       const credlist = await LAMP.Credential.list(passwordDialogResearcher.id)
+       const response = (await LAMP.Credential.update(passwordDialogResearcher.id, passwordDialogResearcher.email, {
+         ...(credlist[0] as any),
+         secret_key: confirmPassword,
+       })) as any
+       console.log("Update response:", response)
+
+       if (response && response.error === "404.no-such-credentials") {
+         console.log("Attempting to create new credential...")
+         await LAMP.Credential.create(passwordDialogResearcher.id, passwordDialogResearcher.email, confirmPassword)
+         enqueueSnackbar("Successfully created new credential", { variant: "success" })
+       } else {
+         enqueueSnackbar("Successfully updated credential", { variant: "success" })
+       }
+     } catch (updateError) {
+       console.error("Operation error:", updateError)
+       throw updateError
+     }
+
+     setShowPasswordDialog(false)
+     setPasswordDialogResearcher(null)
+   } catch (error) {
+     console.error("Final error:", error)
+     enqueueSnackbar(`Failed to create/update credential: ${error.message || "Unknown error"}`, { variant: "error" })
+   }
+ }
+
+ const handleClosePasswordDialog = () => {
+   setShowPasswordDialog(false)
+   setPasswordError("")
+   setPasswordDialogResearcher(null)
+ }

  // const confirmActionTable = async (status) => {
  //   if (status === "Yes" && editingResearcher) {
  //     try {
  //       await LAMP.Researcher.delete(editingResearcher.id)
  //       enqueueSnackbar("Deleted researcher", { variant: "success" })
  //       refreshResearchers?.()
  //     } catch {
  //       enqueueSnackbar("Failed to delete", { variant: "error" })
  //     }
  //   }
  //   setConfirmationDialogTable(false)
  //   setEditingResearcher(null)
  // }

  const confirmActionTable = async (status) => {
    if (status === "Yes" && editingResearcher) {
      try {
        const credentials = await LAMP.Credential.list(editingResearcher.id)
        const filteredCreds = credentials.filter((c) => c.hasOwnProperty("origin"))

        await Promise.all(
          filteredCreds.map((cred) =>
            LAMP.Credential.delete(editingResearcher.id, cred["access_key"]).catch((error) => {
              console.error(`Failed to delete credential ${cred["access_key"]}:`, error)
              throw error
            })
          )
        )

        const deleteResult = (await LAMP.Researcher.delete(editingResearcher.id)) as any

        if (deleteResult?.error === undefined) {
          enqueueSnackbar(t("Successfully deleted the investigator and all associated credentials."), {
            variant: "success",
          })
        } else {
          enqueueSnackbar(t("Failed to delete the investigator."), {
            variant: "error",
          })
        }
        refreshResearchers?.()
      } catch (error) {
        enqueueSnackbar(t("Failed to delete the investigator or their credentials."), {
          variant: "error",
        })
        console.error(`Error in deletion process for researcher ${editingResearcher.id}:`, error)
      }
    }
    setConfirmationDialogTable(false)
    setEditingResearcher(null)
  }

  // ... rest of the component logic remains the same ...

  return (
    <React.Fragment>
      <div className="table-container">
        {showCopyTooltip && <CopyTooltip text="Copied!" position={tooltipPosition} />}
        <ConfirmationDialog
          confirmationDialog={confirmationDialogTable ? 1 : 0}
          open={!!confirmationDialogTable}
          onClose={() => setConfirmationDialogTable(false)}
          confirmAction={confirmActionTable}
          confirmationMsg="Are you sure you want to delete this investigator?"
        />
+       {/* Password Reset Dialog */}
+       <Dialog open={showPasswordDialog} onClose={handleClosePasswordDialog} aria-labelledby="form-dialog-title">
+         <DialogTitle id="form-dialog-title">Reset Researcher Password</DialogTitle>
+         <DialogContent>
+           {passwordError && (
+             <Typography color="error" variant="body2" gutterBottom>
+               {passwordError}
+             </Typography>
+           )}
+           <TextField
+             autoFocus
+             margin="dense"
+             id="new-password"
+             label="New Password"
+             type="password"
+             fullWidth
+             value={updatedPassword}
+             onChange={(e) => setUpdatedPassword(e.target.value)}
+           />
+           <TextField
+             margin="dense"
+             id="confirm-password"
+             label="Confirm Password"
+             type="password"
+             fullWidth
+             value={confirmPassword}
+             onChange={(e) => setConfirmPassword(e.target.value)}
+           />
+         </DialogContent>
+         <DialogActions>
+           <Button onClick={handleClosePasswordDialog} color="primary">
+             Close
+           </Button>
+           <Button onClick={handleSubmitPassword} color="primary" variant="contained">
+             Submit
+           </Button>
+         </DialogActions>
+       </Dialog>
        <CommonTable
          data={data}
          columns={columns}
          actions={actions}
          selectable={true}
          selectedRows={selectedRows}
          onSelectRow={(ids) => setSelectedRows(ids)}
          onSelectAll={() => setSelectedRows(selectedRows.length === data.length ? [] : data.map((r) => r.id))}
          sortConfig={{ field: null, direction: null }}
          onSort={() => {}}
          indexmap={data.reduce((acc, r, i) => ({ ...acc, [r.id]: i }), {})}
          renderCell={renderCellContent}
          filters={filters}
          onFilter={setFilters}
          filterDisplay="menu"
          categorizeItems={null}
        />
      </div>
    </React.Fragment>
  )