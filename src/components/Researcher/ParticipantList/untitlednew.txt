const AsyncStatsContent: React.FC<{
  selectedTab: any
  study: any
  participant: any
  classes: any
}> = ({ selectedTab, study, participant, classes }) => {
  const [items, setItems] = useState<any[]>([])
  const [loading, setLoading] = useState(true)
  const [expandedIndex, setExpandedIndex] = useState<number | null>(null)
  const [startDate, setStartDate] = useState<Date | null>(
    new Date(new Date().setDate(new Date().getDate() - 7)) // Default to 7 days ago
  );
  const [endDate, setEndDate] = useState<Date | null>(new Date()); // Default to today
  const [dateRangeEnabled, setDateRangeEnabled] = useState<boolean>(false);

  useEffect(() => {
    const fetchStats = async () => {
      setLoading(true)
      try {
        const authString = LAMP.Auth._auth.id + ":" + LAMP.Auth._auth.password
        let newItems: any[] = []
        
        if (dateRangeEnabled) {
          // Use new endpoint for date range queries
          if (selectedTab.tab === "activities") {
            const endpoint = `participant/${participant.id}/_lookup/mode/1?from_date=${startDate?.getTime()}&to_date=${endDate?.getTime()}`;
            const result = await fetchResult(authString, endpoint, "participant");
            
            // Process activity events
            newItems = (study.activities || []).map((activity) => {
              const activityData = result.activity_events?.find(a => a.activity_id === activity.id);
              return {
                ...activity,
                events: activityData?.events || []
              };
            });
          } else if (selectedTab.tab === "sensors") {
            const endpoint = `participant/${participant.id}/_lookup/mode/2?from_date=${startDate?.getTime()}&to_date=${endDate?.getTime()}`;
            const result = await fetchResult(authString, endpoint, "participant");
            
            // Process sensor events
            newItems = (study.sensors || []).map((sensor) => {
              const sensorData = result.sensor_events?.find(s => s.sensor_spec === sensor.spec);
              return {
                ...sensor,
                events: sensorData?.events || []
              };
            });
          } else if (selectedTab.tab === "assessments") {
            newItems = study.activities?.filter((a) => a.category?.includes("assess")) || []
          }
        } else {
          // Use existing endpoint for last events
          const result = await fetchResult(authString, study.id, "participant/mode/5", "study");
          const participantData = result.participants?.find((p) => p.id === participant.id);
          
          if (selectedTab.tab === "assessments") {
            newItems = study.activities?.filter((a) => a.category?.includes("assess")) || []
          } else if (selectedTab.tab === "activities") {
            newItems = (study.activities || []).map((activity) => {
              const activityEvent = participantData?.last_activity_events?.find((e) => e.activity_id === activity.id)
              return {
                ...activity,
                lastEvent: activityEvent?.last_event
                  ? {
                    ...activityEvent.last_event,
                    timestamp: new Date(activityEvent.last_event.timestamp).toLocaleString(),
                  }
                  : null,
              }
            })
          } else if (selectedTab.tab === "sensors") {
            newItems = (study.sensors || []).map((sensor) => {
              const sensorEvent = participantData?.last_sensor_events?.find((s) => s.sensor_spec === sensor.spec)
              return {
                ...sensor,
                lastEvent: sensorEvent?.last_event
                  ? {
                    ...sensorEvent.last_event,
                    timestamp: new Date(sensorEvent.last_event.timestamp).toLocaleString(),
                  }
                  : null,
              }
            })
          }
        }

        setItems(newItems)
      } catch (err) {
        console.error("Failed to fetch stats:", err)
        setItems([])
      } finally {
        setLoading(false)
      }
    }

    fetchStats()
  }, [selectedTab, study, participant, dateRangeEnabled, startDate, endDate])

  // Helper function to fetch the data (updated to support participant endpoints)
  const fetchResult = async (authString, id, endpoint, type = "study") => {
    try {
      const headers = {
        Authorization: `Basic ${btoa(authString)}`,
        "Content-Type": "application/json",
      };
      
      let url;
      if (type === "study") {
        url = `${process.env.REACT_APP_API_URL}/researcher/study/${id}/_lookup/${endpoint}`;
      } else if (type === "participant") {
        url = `${process.env.REACT_APP_API_URL}/researcher/${endpoint}`;
      }
      
      const response = await fetch(url, { headers });
      if (!response.ok) {
        throw new Error(`HTTP error ${response.status}`);
      }
      return await response.json();
    } catch (error) {
      console.error("Error fetching data:", error);
      throw error;
    }
  };

  // ... rest of the component remains the same ...
}