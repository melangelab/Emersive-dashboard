const handleSave = async () => {
  let isSubscribed = true
  // Validate required fields
  if (!editedValues.name || !editedValues.spec || !editedValues.study_id) {
    enqueueSnackbar(t("Please fill in all required fields"), { variant: "error" })
    return
  }

  if (editedValues.spec === "lamp.mood_tracker") {
    if (editedValues.settings[0].options.length === 0) {
      enqueueSnackbar(t("Please select at least one emotion/upper rate limit"), { variant: "error" })
      return
    } else if (editedValues.settings[0].settings.upperRatingLimit === "") {
      enqueueSnackbar(t("Please select upper rate limit"), { variant: "error" })
      return
    }
  }

  setLoading(true)
  try {
    // Prepare activity data
    const activityData = {
      name: editedValues.name?.trim(),
      spec: editedValues.spec,
      settings: editedValues.settings || {},
      formula4Fields: editedValues.formula4Fields,
      schedule: null, // Set to null instead of empty array
      category: editedValues.category,
      groups: editedValues.groups,
      scoreInterpretation: {},
      activityGuide: null,
      studyID: editedValues.study_id,
      streak: editedValues.streak,
      description: editedValues.description,
      photo: editedValues.photo,
      showFeed: editedValues.showInFeed,
    } as any
    
    let newActivityId
    if (activityData.spec === "lamp.form_builder") {
      console.log("CREATING ACTIVIITY activityData", activityData)
      const result = (await LAMP.Activity.create(editedValues.study_id, {
        ...activityData,
      } as any)) as any
      newActivityId = result.data ? result.data : result
      console.log("CREATED ACTIVITY", result.data)
    } else if (activityData.spec === "lamp.survey") {
      const result = (await LAMP.Activity.create(editedValues.study_id, {
        ...activityData,
        settings: editedValues.settings,
      } as any)) as any
      console.log("result", result)
      newActivityId = result.data ? result.data : result
    } else if (activityData.spec === "lamp.tips") {
      const result = await saveTipActivity({
        ...activityData,
        studyID: editedValues.study_id,
      })
      console.log("result", result)
      newActivityId = result.data
    } else {
      const result = await saveCTestActivity({
        ...activityData,
        studyID: editedValues.study_id,
      })
      console.log("result", result)
      newActivityId = result.data
    }
    console.log("newActivityId", newActivityId)

    // Set additional details as attachments
    await LAMP.Type.setAttachment(newActivityId, "me", "emersive.activity.details", {
      description: editedValues.description,
      photo: editedValues.photo,
      streak: editedValues.streak,
      showFeed: editedValues.showInFeed,
    })

    // Get the current study object from ServiceDB (similar to sensor code)
    const studiesObject = await Service.getData("studies", editedValues.study_id)
    
    // Get the created activity data
    const activitydata = await LAMP.Activity.view(newActivityId)
    
    // Create activity object for local DB
    const newActivity = {
      id: newActivityId,
      ...activitydata,
      settings: editedValues.settings,
      description: editedValues.description,
      formula4Fields: editedValues.formula4Fields,
      photo: editedValues.photo,
      showFeed: editedValues.showInFeed,
      streak: editedValues.streak,
      study_id: editedValues.study_id,
      study_name: studies.find((s) => s.id === editedValues.study_id)?.name,
    }
    console.log("newActivity", newActivity)
    
    // Add to local activities DB
    await Service.addData("activities", [newActivity])

    // Update study object with new activity (similar to sensor code)
    const updatedActivities = [...(studiesObject?.activities || []), activitydata ?? newActivity]
    console.log("UPDATED ACTIVITIES", updatedActivities)
    
    const updatedStudy = { 
      ...studiesObject, 
      activities: updatedActivities, 
      activity_count: updatedActivities.length ?? 1 
    }
    console.log("UPDATED STUDY", updatedStudy)

    // Update study in LAMP
    await LAMP.Study.update(editedValues.study_id, updatedStudy)
    
    // Update study in local ServiceDB
    await Service.update(
      "studies",
      {
        studies: [
          {
            id: editedValues.study_id,
            ...updatedStudy,
          },
        ],
      },
      "name",
      "id"
    )
    
    // Update multiple keys in ServiceDB (activity_count and activities)
    await Service.updateMultipleKeys(
      "studies",
      {
        studies: [
          {
            id: studiesObject.id,
            activity_count: studiesObject.activity_count ? studiesObject.activity_count + 1 : 1,
            activities: updatedActivities,
          },
        ],
      },
      ["activity_count", "activities"],
      "id"
    )

    if (isSubscribed) {
      enqueueSnackbar(t("Activity created successfully"), { variant: "success" })
      onSave(activitydata)
    }
  } catch (error) {
    if (isSubscribed) {
      console.error("Error creating activity:", error)
      enqueueSnackbar(t("Failed to create activity"), { variant: "error" })
    }
  } finally {
    if (isSubscribed) {
      setLoading(false)
    }
  }

  return () => {
    isSubscribed = false
  }
}