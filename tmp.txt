import React, { useEffect, useState } from "react"
import ActivityList from "../Researcher/ActivityList/Index"
import { useTranslation } from "react-i18next"
import { useSnackbar } from "notistack"
import { useQuery } from "../Utils"
import LAMP from "lamp-core"
import { sortData } from "../Researcher/Dashboard"
import { ReactComponent as ViewIcon } from "../../icons/NewIcons/overview.svg"
import { ReactComponent as ViewFilledIcon } from "../../icons/NewIcons/overview-filled.svg"
import { ReactComponent as CopyFilledIcon } from "../../icons/NewIcons/arrow-circle-down-filled.svg"
import { ReactComponent as CopyIcon } from "../../icons/NewIcons/arrow-circle-down.svg"
import { ReactComponent as DeleteIcon } from "../../icons/NewIcons/trash-xmark.svg"
import { ReactComponent as DeleteFilledIcon } from "../../icons/NewIcons/trash-xmark-Deleted.svg"
import { ReactComponent as EditIcon } from "../../icons/NewIcons/text-box-edit.svg"
import { ReactComponent as EditFilledIcon } from "../../icons/NewIcons/text-box-edit-filled.svg"
import { ReactComponent as HistoryIcon } from "../../icons/NewIcons/version-history.svg"
import { ReactComponent as HistoryFilledIcon } from "../../icons/NewIcons/version-history.svg"
import { ReactComponent as ShareCommunityIcon } from "../../icons/NewIcons/refer.svg"
import { ReactComponent as ShareCommunityFilledIcon } from "../../icons/NewIcons/refer-filled.svg"
import { ReactComponent as RemoveCommunityIcon } from "../../icons/NewIcons/user-xmark.svg"
import { ReactComponent as RemoveCommunityFilledIcon } from "../../icons/NewIcons/user-xmark-filled.svg"
import { ReactComponent as VersionThisIcon } from "../../icons/NewIcons/code-merge.svg"
import { ReactComponent as VersionThisFilledIcon } from "../../icons/NewIcons/code-merge-filled.svg"
import { ReactComponent as SaveIcon } from "../../icons/NewIcons/floppy-disks.svg"
import { ReactComponent as SaveFilledIcon } from "../../icons/NewIcons/floppy-disks-filled.svg"
import EmersiveTable, { ColumnConfig } from "../Researcher/EmersiveTable"

interface ActivityDevlabProps {
  researcherId: string
  title: string
  studies: any[]
  selectedStudies: string[]
  setSelectedStudies: (studies: string[]) => void
  setOrder: (order: string) => void
  order: string
  getAllStudies: () => void
  ptitle: string
  authType: string
  onLogout: () => void
  sharedstudies: any[]
  adminName?: string
}

const ActivityDevlab: React.FC<ActivityDevlabProps> = ({
  researcherId,
  title,
  studies,
  selectedStudies,
  setSelectedStudies,
  setOrder,
  order,
  getAllStudies,
  ptitle,
  authType,
  onLogout,
  sharedstudies,
  adminName
}) => {
  const [activities, setActivities] = useState(null)
  const { t } = useTranslation()
  const { enqueueSnackbar } = useSnackbar()
  const [selectedActivities, setSelectedActivities] = useState<any>([])
  const [loading, setLoading] = useState(true)
  const [paginatedActivities, setPaginatedActivities] = useState([])
  const [selected, setSelected] = useState(selectedStudies)
  const [rowCount, setRowCount] = useState(40)
  const [page, setPage] = useState(0)
  const [search, setSearch] = useState(null)
  const query = useQuery()
  const filterParam = query.get("filter")
  const [communityActivities, setCommunityActivities] = useState([])
  const [viewingActivity, setViewingActivity] = useState(null)
  const [isEditing, setIsEditing] = useState(false)
  const [triggerSave, setTriggerSave] = useState(false)
  const [creatingActivity, setCreatingActivity] = useState(false)
  const [selectedSpec, setSelectedSpec] = useState(null)
  const [editingActivity, setEditingActivity] = useState(null)
  const [editedValues, setEditedValues] = useState<{ [key: string]: any }>({})
  const [rowMode, setRowMode] = useState("view")
  const [allresearchers, setAllResearchers] = useState([])
  const [tabularView, setTabularView] = useState(false)
  const [activeButton, setActiveButton] = useState({ id: null, action: null })
  const [confirmationDialog, setConfirmationDialog] = useState(false)
  const [shareDialogOpen, setShareDialogOpen] = useState(false)
  const [versionHistoryOpen, setVersionHistoryOpen] = useState(false)
  const [previewDialogOpen, setPreviewDialogOpen] = useState(false)
  const [selectedVersion, setSelectedVersion] = useState(null)
  const [duplicateDialogOpen, setDuplicateDialogOpen] = useState(false)
  const [dialogActivity, setDialogActivity] = useState(null)
  const [selectedStudyForDuplicate, setSelectedStudyForDuplicate] = useState("")
  const [duplicateLoading, setDuplicateLoading] = useState(false)
  const [sortConfig, setSortConfig] = useState({ field: null, direction: null })
  const [confirmationVersionDialog, setConfirmationVersionDialog] = useState(false)
  const [selectedRows, setSelectedRows] = useState([])
  const [currentPage, setCurrentPage] = useState(0)
  const [currentRowsPerPage, setCurrentRowsPerPage] = useState(5)

  useEffect(() => {
    let params = JSON.parse(localStorage.getItem("devlabactivities"))
    setPage(params?.page ?? 0)
    setRowCount(params?.rowCount ?? 40)
  }, [])
  useEffect(() => {
    if (selected !== selectedStudies) setSelected(selectedStudies)
  }, [selectedStudies])
  useEffect(() => {
    if ((selected || []).length > 0) {
      searchActivities()
    } else {
      setActivities([])
      setLoading(false)
    }
  }, [selected])
    useEffect(() => {
      const fetchResearchers = async () => {
        try {
          const res = await LAMP.Researcher.all()
          setAllResearchers(res)
          console.warn("All researchers:", res)
        } catch (error) {
          console.error("Error fetching researchers:", error)
        }
      }
      fetchResearchers()
  }, [])

  const getParentResearcher = (parentResearcherId) => {
    const researcher = allresearchers.find((r) => r.id === parentResearcherId)
    return researcher ? researcher.name : parentResearcherId
  }

  const searchActivities = async (searchVal?: string) => {
    const searchTxt = searchVal ?? search
    // const selectedData = selected.filter((o) => studies.some(({ name }) => o === name))
    const selectedData = selected?.filter((o) => studies?.some(({ name }) => o === name)) || []
    if (selectedData.length > 0) {
      setLoading(true)
      try {
        const activitiesData = await LAMP.Activity.all()
        console.log("activitiesData", activitiesData)
        let filteredData = activitiesData || []
        if (filterParam) {
          filteredData = filteredData.filter((factivity) => factivity.id === filterParam)
        } else if (!!searchTxt && searchTxt.trim?.().length > 0) {
          filteredData = filteredData.filter(
            (factivity) =>
              factivity.name?.toLowerCase().includes(searchTxt?.toLowerCase?.()) ||
              factivity.id?.toLowerCase().includes(searchTxt?.toLowerCase?.())
          )
        }
        const sortedData = sortData(filteredData, selectedData, "name")
        setActivities(sortedData)
        setPaginatedActivities(sortedData.slice(page * rowCount, page * rowCount + rowCount))
        console.log(
          "setPaginatedActivities",
          sortedData,
          sortedData.slice(page * rowCount, page * rowCount + rowCount)
        )
        // enqueueSnackbar("Fetched all activities", {variant:"success",autoHideDuration:1000})
      } catch (error) {
        console.error("Error searching activities:", error)
        enqueueSnackbar(t("Failed to search activities"), { variant: "error" })
      } finally {
        setLoading(false)
      }
    } else {
      setActivities([])
      setPaginatedActivities([])
      setLoading(false)
    }
    setSelectedActivities([])
    setLoading(false)
  }
  
  const handleSearchData = (val: string) => {
    setSearch(val)
    searchActivities(val)
  }

  const handleChangePage = (page: number, rowCount: number) => {
    setLoading(true)
    setRowCount(rowCount)
    setPage(page)
    localStorage.setItem("devlabactivities", JSON.stringify({ page: page, rowCount: rowCount }))
    // const selectedData = selected.filter((o) => studies.some(({ name }) => o === name))
    const selectedData = selected?.filter((o) => studies?.some(({ name }) => o === name)) || []
    const combinedActivities = [...activities, ...communityActivities]
    setPaginatedActivities(
      sortData(combinedActivities, selectedData, "name").slice(page * rowCount, page * rowCount + rowCount)
    )
    setLoading(false)
  }

  const handleUpdateActivity = async (activityId, updatedActivity) => {
    try {
      const updActivity = (await LAMP.Activity.update(activityId, updatedActivity)) as any
      console.log("after updating", updActivity)
      await searchActivities()
      enqueueSnackbar(t("Activity updated successfully."), { variant: "success" })
    } catch (err) {
      console.error("Error updating activity:", err)
      enqueueSnackbar(t("Failed to update activity: ") + err.message, { variant: "error" })
    } finally {
      setLoading(false)
    }
  }
  const formatDate = (date) => {
    return date ? new Date(date).toLocaleDateString() : "Not available"
  }

  const handleCellValueChange = (activityId: string, field: string, value: any) => {
    console.warn("handleCellValueChange", activityId, field, value, editedValues)
    setEditedValues((prev) => ({
      ...prev,
      [field]: value,
    }))
  }

  const handleViewActivity = (activity) => {
    setViewingActivity(activity)
    setIsEditing(false)
    setTriggerSave(false)
  }
  
  const handleEditActivityTable = (activity: any) => {
    // const handleEditActivityTable = (activity: any) => {
    console.warn("Editing activity in table:", activity?.id, editingActivity?.id, rowMode, activeButton)
    if (editingActivity?.id === activity.id) {
      // Cancel edit mode
      setRowMode("view")
      setEditingActivity(null)
      setEditedValues({})
      setActiveButton({ id: null, action: null })
      console.warn("Canceling edit mode for:", activity?.id, editingActivity?.id, rowMode, activeButton)
    } else {
      // Start editing
      setEditingActivity(activity)
      setRowMode("edit")
      setEditedValues({
        name: activity.name,
        groups: activity.groups || [],
      })
      setActiveButton({ id: activity.id, action: "edit" })
      console.warn("Starting edit mode for:", activity?.id, editingActivity?.id, rowMode, activeButton)
    }
  }
  const handleSaveActivityTable = async (activity: any) => {
    if (Object.keys(editedValues).length > 0) {
      try {
        const updatedActivity = {
          ...activity,
          ...editedValues,
        }
        setEditingActivity(null)
        setEditedValues({})
        setRowMode("view")
        setActiveButton({ id: null, action: null })
        await handleUpdateActivity(activity.id, updatedActivity)
        enqueueSnackbar(t("Activity updated successfully"), { variant: "success" })
      } catch (error) {
        console.error("Error updating activity:", error)
        enqueueSnackbar(t("Failed to update activity"), { variant: "error" })
      }
    } else {
      enqueueSnackbar(t("No changes to save"), { variant: "info" })
      setEditingActivity(null)
      setRowMode("view")
      setActiveButton({ id: null, action: null })
    }
  }
  
  const activityActions = (activity: any) => {
    const isCommunity = activity.isCommunityActivity

    return (
      <span className="action-buttons">
        {/* View button */}
        {activeButton.id === activity.id && activeButton.action === "view" ? (
          <ViewFilledIcon
            className="actionIcon"
            onClick={() => {
              setActiveButton({ id: activity.id, action: "view" })
              handleViewActivity(activity)
            }}
          />
        ) : (
          <ViewIcon
            className="actionIcon"
            onClick={() => {
              setActiveButton({ id: activity.id, action: "view" })
              handleViewActivity(activity)
            }}
          />
        )}
        {/* Copy button */}
        {isCommunity && (
          <>
            {activeButton.id === activity.id && activeButton.action === "copy" ? (
              <CopyFilledIcon
                className="actionIcon"
                onClick={() => {
                  setActiveButton({ id: activity.id, action: "copy" })
                  setDialogActivity(activity)
                  setDuplicateDialogOpen(true)
                }}
              />
            ) : (
              <CopyIcon
                className="actionIcon"
                onClick={() => {
                  setActiveButton({ id: activity.id, action: "copy" })
                  setDialogActivity(activity)
                  setDuplicateDialogOpen(true)
                }}
              />
            )}
          </>
        )}
        {!isCommunity && (
          <>
            {/* Edit/Save buttons */}
            {(
              <>
                {activeButton.id === activity.id && activeButton.action === "edit" ? (
                  <EditFilledIcon className="actionIcon" onClick={() => handleEditActivityTable(activity)} />
                ) : (
                  <EditIcon className="actionIcon" onClick={() => handleEditActivityTable(activity)} />
                )}
                {activeButton.id === activity.id && activeButton.action === "save" ? (
                  <SaveFilledIcon className="actionIcon" onClick={() => handleSaveActivityTable(activity)} />
                ) : (
                  <SaveIcon className="actionIcon" onClick={() => handleSaveActivityTable(activity)} />
                )}
              </>
            )}

            {/* History button */}
            {activeButton.id === activity.id && activeButton.action === "history" ? (
              <HistoryFilledIcon
                className="actionIcon"
                onClick={() => {
                  setActiveButton({ id: activity.id, action: "history" })
                  setDialogActivity(activity)
                  setVersionHistoryOpen(true)
                }}
              />
            ) : (
              <HistoryIcon
                className="actionIcon"
                onClick={() => {
                  setActiveButton({ id: activity.id, action: "history" })
                  setDialogActivity(activity)
                  setVersionHistoryOpen(true)
                }}
              />
            )}

            {/* Share/Unshare button */}
            {!activity.isShared && (
              <>
                {activeButton.id === activity.id && activeButton.action === "share" ? (
                  !activity.shareTocommunity ? (
                    <ShareCommunityFilledIcon
                      className="actionIcon"
                      onClick={() => {
                        setActiveButton({ id: activity.id, action: "share" })
                        setDialogActivity(activity)
                        setShareDialogOpen(true)
                      }}
                    />
                  ) : (
                    <RemoveCommunityFilledIcon
                      className="actionIcon"
                      onClick={() => {
                        setActiveButton({ id: activity.id, action: "share" })
                        setDialogActivity(activity)
                        setShareDialogOpen(true)
                      }}
                    />
                  )
                ) : activity.shareTocommunity ? (
                  <RemoveCommunityIcon
                    className="actionIcon"
                    onClick={() => {
                      setActiveButton({ id: activity.id, action: "share" })
                      setDialogActivity(activity)
                      setShareDialogOpen(true)
                    }}
                  />
                ) : (
                  <ShareCommunityIcon
                    className="actionIcon"
                    onClick={() => {
                      setActiveButton({ id: activity.id, action: "share" })
                      setDialogActivity(activity)
                      setShareDialogOpen(true)
                    }}
                  />
                )}
              </>
            )}

            {/* Version button */}
            {(
              <>
                {activeButton.id === activity.id && activeButton.action === "version" ? (
                  <VersionThisFilledIcon
                    className="actionIcon"
                    onClick={() => {
                      setActiveButton({ id: activity.id, action: "version" })
                      setDialogActivity(activity)
                      setConfirmationVersionDialog(true)
                    }}
                  />
                ) : (
                  <VersionThisIcon
                    className="actionIcon"
                    onClick={() => {
                      setActiveButton({ id: activity.id, action: "version" })
                      setDialogActivity(activity)
                      setConfirmationVersionDialog(true)
                    }}
                  />
                )}
              </>
            )}
          </>
        )}
        {/* Delete button */}
        {!isCommunity &&
          !activity.isShared &&
          
          (activeButton.id === activity.id && activeButton.action === "delete" ? (
            <DeleteFilledIcon
              className="actionIcon"
              onClick={() => {
                setActiveButton({ id: activity.id, action: "delete" })
                setDialogActivity(activity)
                setConfirmationDialog(true)
              }}
            />
          ) : (
            <DeleteIcon
              className="actionIcon"
              onClick={() => {
                setActiveButton({ id: activity.id, action: "delete" })
                setDialogActivity(activity)
                setConfirmationDialog(true)
              }}
            />
          ))}
      </span>
    )
  }


  console.log("ActivityDevlab rendered with props:", {
    researcherId,
    title,
    studies,
    selectedStudies,
    order,
    ptitle,
    authType,
    sharedstudies,
    adminName
  })
  return (
    <ActivityList
      researcherId={researcherId}
      title={title}
      studies={studies}
      selectedStudies={selectedStudies}
      setSelectedStudies={setSelectedStudies}
      setOrder={setOrder}
      order={order}
      getAllStudies={getAllStudies}
      ptitle={title}
      authType={authType}
      onLogout={onLogout}
      sharedstudies={sharedstudies}
    />
  )
}

export default ActivityDevlab
