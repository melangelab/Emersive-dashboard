export default function ActivityList({
  researcherId,
  title,
  studies,
  selectedStudies,
  setSelectedStudies,
  setOrder,
  order,
  getAllStudies,
  ...props
}) {
  const [activities, setActivities] = useState(null)
  const { t } = useTranslation()
  const { enqueueSnackbar, closeSnackbar } = useSnackbar()
  const classes = useStyles()
  const [selectedActivities, setSelectedActivities] = useState<any>([])
  const [loading, setLoading] = useState(true)
  const [paginatedActivities, setPaginatedActivities] = useState([])
  const [selected, setSelected] = useState(selectedStudies)
  const [allActivities, setAllActivities] = useState(null)
  const [rowCount, setRowCount] = useState(40)
  const [page, setPage] = useState(0)
  const [search, setSearch] = useState(null)
  const layoutClasses = useLayoutStyles()
  const [viewMode, setViewMode] = useState("grid")
  const query = useQuery()
  const filterParam = query.get("filter")
  const [communityActivities, setCommunityActivities] = useState([])
  const supportsSidebar = useMediaQuery(useTheme().breakpoints.up("md"))
  const [viewingActivity, setViewingActivity] = useState(null)
  const [isEditing, setIsEditing] = useState(false)
  const [triggerSave, setTriggerSave] = useState(false)
  const [creatingActivity, setCreatingActivity] = useState(false)
  const [selectedSpec, setSelectedSpec] = useState(null)
  const [editingActivity, setEditingActivity] = useState(null)
  const [editedValues, setEditedValues] = useState<{ [key: string]: any }>({})
  const [rowMode, setRowMode] = useState("view")
  const [sharedActivities, setSharedActivities] = useState([])
  const [allresearchers, setAllResearchers] = useState([])
  const [tabularView, setTabularView] = useState(false)
  // const [versionHistoryActivity, setVersionHistoryActivity] = useState(null)
  // New state variables for table editing
  const [activeButton, setActiveButton] = useState({ id: null, action: null })
  const [confirmationDialog, setConfirmationDialog] = useState(false)
  const [shareDialogOpen, setShareDialogOpen] = useState(false)
  const [versionHistoryOpen, setVersionHistoryOpen] = useState(false)
  const [previewDialogOpen, setPreviewDialogOpen] = useState(false)
  const [selectedVersion, setSelectedVersion] = useState(null)
  const [duplicateDialogOpen, setDuplicateDialogOpen] = useState(false)
  const [dialogActivity, setDialogActivity] = useState(null)
  const [selectedStudyForDuplicate, setSelectedStudyForDuplicate] = useState("")
  const [duplicateLoading, setDuplicateLoading] = useState(false)
  const [sortConfig, setSortConfig] = useState({ field: null, direction: null })
  const [confirmationVersionDialog, setConfirmationVersionDialog] = useState(false)
  useInterval(
    () => {
      setLoading(true)
      getAllStudies()
    },
    (!studies || studies.length === 0) && (!props.sharedstudies || props.sharedstudies.length === 0) ? 60000 : null,
    true
  )

  useEffect(() => {
    // LAMP.ActivitySpec.all().then((res) => console.log(res))
    let params = JSON.parse(localStorage.getItem("activities"))
    setPage(params?.page ?? 0)
    setRowCount(params?.rowCount ?? 40)
    // setFilters(initFilters())
  }, [])

  useEffect(() => {
    if (selected !== selectedStudies) setSelected(selectedStudies)
  }, [selectedStudies])

  useEffect(() => {
    if ((selected || []).length > 0) {
      searchActivities()
    } else {
      setActivities([])
      setLoading(false)
    }
  }, [selected])

  useEffect(() => {
    const fetchResearchers = async () => {
      try {
        const authString = LAMP.Auth._auth.id + ":" + LAMP.Auth._auth.password
        const response = await fetchGetData(authString, `researcher/others/list`, "researcher")
        setAllResearchers(response.data)
        console.warn("All researchers:", response.data)
      } catch (error) {
        console.error("Error fetching researchers:", error)
      }
    }

    fetchResearchers()
  }, [])

  const getParentResearcher = (parentResearcherId) => {
    const researcher = allresearchers.find((r) => r.id === parentResearcherId)
    // console.log("getParentResearcher", parentResearcherId, researcher)
    return researcher ? researcher.name : parentResearcherId
  }

  const handleChange = (activity, checked) => {
    if (checked) {
      setSelectedActivities((prevState) => [...prevState, activity])
    } else {
      let selected = selectedActivities.filter((item) => item.id != activity.id)
      setSelectedActivities(selected)
    }
  }

  const searchActivities = async (searchVal?: string) => {
    const searchTxt = searchVal ?? search
    // const selectedData = selected.filter((o) => studies.some(({ name }) => o === name))
    const selectedstudiesData = selected?.filter((o) => studies?.some(({ name }) => o === name)) || []
    const selectedsharedData = props.sharedstudies
      ? selected.filter((o) => props.sharedstudies?.some(({ name }) => o === name))
      : []
    const selectedData = [...selectedstudiesData, ...selectedsharedData]
    if (selectedData.length > 0) {
      setLoading(true)
      try {
        const activitiesData = await Service.getAll("activities")
        setAllActivities(activitiesData)
        console.log("activitiesData", activitiesData)
        const resylt = Array.isArray(activitiesData) ? activitiesData : []
        const ids = resylt.map((activity) => activity.id)
        const detailedActivities = await Promise.all(
          ids.map((id) => Service.getDataByKey("activities", [id], "id").then((data) => data[0]))
        )
        console.log("Detailed Activities:", detailedActivities)
        // const detailedLActivities = await Promise.all(ids.map((id) => LAMP.Activity.view(id)))
        // console.log("Detailed L Activities:", detailedLActivities)

        let filteredData = activitiesData || []
        if (filterParam) {
          filteredData = filteredData.filter((factivity) => factivity.id === filterParam)
        } else if (!!searchTxt && searchTxt.trim?.().length > 0) {
          filteredData = filteredData.filter(
            (factivity) =>
              factivity.name?.toLowerCase().includes(searchTxt?.toLowerCase?.()) ||
              factivity.id?.toLowerCase().includes(searchTxt?.toLowerCase?.())
          )
        }
        const sortedData = sortData(filteredData, selectedData, "name")
        setActivities(sortedData)
        const fetchedCommunityActivities = await fetchCommunityActivities()
        const filteredCommunityActivities = fetchedCommunityActivities.filter(
          (activity) =>
            !searchTxt ||
            activity.name?.toLowerCase().includes(searchTxt?.toLowerCase?.()) ||
            activity.id?.toLowerCase().includes(searchTxt?.toLowerCase?.())
        )
        const combinedActivities = [...sortedData, ...filteredCommunityActivities]
        setPaginatedActivities(combinedActivities.slice(page * rowCount, page * rowCount + rowCount))
        console.log(
          "setPaginatedActivities",
          combinedActivities,
          combinedActivities.slice(page * rowCount, page * rowCount + rowCount)
        )
        // enqueueSnackbar("Fetched all activities", {variant:"success",autoHideDuration:1000})
      } catch (error) {
        console.error("Error searching activities:", error)
        enqueueSnackbar(t("Failed to search activities"), { variant: "error" })
      } finally {
        setLoading(false)
      }
    } else {
      setActivities([])
      setPaginatedActivities([])
      setLoading(false)
    }
    setSelectedActivities([])
    setLoading(false)
  }

  const handleSearchData = (val: string) => {
    setSearch(val)
    searchActivities(val)
  }

  const handleChangePage = (page: number, rowCount: number) => {
    setLoading(true)
    setRowCount(rowCount)
    setPage(page)
    localStorage.setItem("activities", JSON.stringify({ page: page, rowCount: rowCount }))
    // const selectedData = selected.filter((o) => studies.some(({ name }) => o === name))
    const selectedstudiesData = selected?.filter((o) => studies?.some(({ name }) => o === name)) || []
    const selectedsharedData = props.sharedstudies
      ? selected.filter((o) => props.sharedstudies?.some(({ name }) => o === name))
      : []
    const selectedData = [...selectedstudiesData, ...selectedsharedData]

    const combinedActivities = [...activities, ...communityActivities]
    setPaginatedActivities(
      sortData(combinedActivities, selectedData, "name").slice(page * rowCount, page * rowCount + rowCount)
    )
    setLoading(false)
  }

  const handleUpdateActivity = async (activityId, updatedActivity) => {
    try {
      const activity = activities.find((a) => a.id === activityId)
      if (activity && !canEditActivity(activity, studies, researcherId, props.sharedStudies)) {
        enqueueSnackbar(t("You don't have permission to update this activity"), { variant: "error" })
        return
      }
      setLoading(true)
      const currentActivity = activities.find((a) => a.id === activityId)
      // Update in LAMP backend
      const updActivity = (await LAMP.Activity.update(activityId, updatedActivity)) as any
      console.log("after updating", updActivity)
      updatedActivity.currentVersion = updActivity["data"].currentVersion
      updatedActivity.versionHistory = updActivity["data"].versionHistory
      console.log("here", updatedActivity.currentVersion, updatedActivity.versionHistory)
      // Update in local service
      await Service.updateMultipleKeys(
        "activities",
        { activities: [{ id: activityId, ...updatedActivity }] },
        [
          "name",
          "spec",
          "schedule",
          "settings",
          "category",
          "creator",
          "createdAt",
          "currentVersion",
          "versionHistory",
          "device",
          "reminder",
          "groups",
          "sharingStudies",
          "scoreInterpretation",
          "activityGuide",
          "formula4Fields",
          "shareTocommunity",
        ],
        "id"
      )
      await searchActivities()
      enqueueSnackbar(t("Activity updated successfully."), { variant: "success" })
    } catch (err) {
      console.error("Error updating activity:", err)
      enqueueSnackbar(t("Failed to update activity: ") + err.message, { variant: "error" })
    } finally {
      setLoading(false)
    }
  }

  const fetchCommunityActivities = async () => {
    try {
      const authString = LAMP.Auth._auth.id + ":" + LAMP.Auth._auth.password
      const response = await fetchGetData(
        authString,
        `researcher/${researcherId}/activity/community-shared`,
        "researcher"
      )

      const transformedActivities = (response.data || []).map((activity) => ({
        ...activity,
        isCommunityActivity: true,
        originalId: activity.id,
      }))
      console.log("community shared", transformedActivities)
      setCommunityActivities(transformedActivities)
      return transformedActivities
    } catch (error) {
      console.error("Error fetching community activities:", error)
      enqueueSnackbar(t("Failed to load community activities"), { variant: "error" })
      return []
    }
  }

  const allActivitiesForDisplay = [...paginatedActivities, ...communityActivities]
  const formatDate = (date) => {
    return date ? new Date(date).toLocaleDateString() : "Not available"
  }




  const handleCellValueChange = (activityId: string, field: string, value: any) => {
    console.log("handleCellValueChange", activityId, field, value, editedValues)
    setEditedValues((prev) => ({
      ...prev,
      [field]: value,
    }))
  }


  // const activityActions = useCallback((activity: any) => {
  const activityActions = (activity: any) => {
    const canEdit = canEditActivity(activity, studies, researcherId, props.sharedstudies)
    const isCommunity = activity.isCommunityActivity

    return (
      <span className="p-datatable-action-buttons">
        {/* View button */}
        {activeButton.id === activity.id && activeButton.action === "view" ? (
          <ViewFilledIcon
            className="actionIcon"
            onClick={() => {
              setActiveButton({ id: activity.id, action: "view" })
              handleViewActivity(activity)
            }}
          />
        ) : (
          <ViewIcon
            className="actionIcon"
            onClick={() => {
              setActiveButton({ id: activity.id, action: "view" })
              handleViewActivity(activity)
            }}
          />
        )}
        {/* Copy button */}
        {isCommunity && (
          <>
            {activeButton.id === activity.id && activeButton.action === "copy" ? (
              <CopyFilledIcon
                className="actionIcon"
                onClick={() => {
                  setActiveButton({ id: activity.id, action: "copy" })
                  setDialogActivity(activity)
                  setDuplicateDialogOpen(true)
                }}
              />
            ) : (
              <CopyIcon
                className="actionIcon"
                onClick={() => {
                  setActiveButton({ id: activity.id, action: "copy" })
                  setDialogActivity(activity)
                  setDuplicateDialogOpen(true)
                }}
              />
            )}
          </>
        )}
        {!isCommunity && (
          <>
            {/* Edit/Save buttons */}
            {canEdit && (
              <>
                {activeButton.id === activity.id && activeButton.action === "edit" ? (
                  <EditFilledIcon className="actionIcon" onClick={() => handleEditActivityTable(activity)} />
                ) : (
                  <EditIcon className="actionIcon" onClick={() => handleEditActivityTable(activity)} />
                )}
                {activeButton.id === activity.id && activeButton.action === "save" ? (
                  <SaveFilledIcon className="actionIcon" onClick={() => handleSaveActivityTable(activity)} />
                ) : (
                  <SaveIcon className="actionIcon" onClick={() => handleSaveActivityTable(activity)} />
                )}
              </>
            )}

            {/* History button */}
            {activeButton.id === activity.id && activeButton.action === "history" ? (
              <HistoryFilledIcon
                className="actionIcon"
                onClick={() => {
                  setActiveButton({ id: activity.id, action: "history" })
                  setDialogActivity(activity)
                  setVersionHistoryOpen(true)
                }}
              />
            ) : (
              <HistoryIcon
                className="actionIcon"
                onClick={() => {
                  setActiveButton({ id: activity.id, action: "history" })
                  setDialogActivity(activity)
                  setVersionHistoryOpen(true)
                }}
              />
            )}

            {/* Share/Unshare button */}
            {canEdit && !activity.isShared && (
              <>
                {activeButton.id === activity.id && activeButton.action === "share" ? (
                  !activity.shareTocommunity ? (
                    <ShareCommunityFilledIcon
                      className="actionIcon"
                      onClick={() => {
                        setActiveButton({ id: activity.id, action: "share" })
                        setDialogActivity(activity)
                        setShareDialogOpen(true)
                      }}
                    />
                  ) : (
                    <RemoveCommunityFilledIcon
                      className="actionIcon"
                      onClick={() => {
                        setActiveButton({ id: activity.id, action: "share" })
                        setDialogActivity(activity)
                        setShareDialogOpen(true)
                      }}
                    />
                  )
                ) : activity.shareTocommunity ? (
                  <RemoveCommunityIcon
                    className="actionIcon"
                    onClick={() => {
                      setActiveButton({ id: activity.id, action: "share" })
                      setDialogActivity(activity)
                      setShareDialogOpen(true)
                    }}
                  />
                ) : (
                  <ShareCommunityIcon
                    className="actionIcon"
                    onClick={() => {
                      setActiveButton({ id: activity.id, action: "share" })
                      setDialogActivity(activity)
                      setShareDialogOpen(true)
                    }}
                  />
                )}
              </>
            )}

            {/* Version button */}
            {canEdit && (
              <>
                {activeButton.id === activity.id && activeButton.action === "version" ? (
                  <VersionThisFilledIcon
                    className="actionIcon"
                    onClick={() => {
                      setActiveButton({ id: activity.id, action: "version" })
                      setDialogActivity(activity)
                      setConfirmationVersionDialog(true)
                    }}
                  />
                ) : (
                  <VersionThisIcon
                    className="actionIcon"
                    onClick={() => {
                      setActiveButton({ id: activity.id, action: "version" })
                      setDialogActivity(activity)
                      setConfirmationVersionDialog(true)
                    }}
                  />
                )}
              </>
            )}
          </>
        )}
        {/* Delete button */}
        {!isCommunity &&
          !activity.isShared &&
          canEdit &&
          (activeButton.id === activity.id && activeButton.action === "delete" ? (
            <DeleteFilledIcon
              className="actionIcon"
              onClick={() => {
                setActiveButton({ id: activity.id, action: "delete" })
                setDialogActivity(activity)
                setConfirmationDialog(true)
              }}
            />
          ) : (
            <DeleteIcon
              className="actionIcon"
              onClick={() => {
                setActiveButton({ id: activity.id, action: "delete" })
                setDialogActivity(activity)
                setConfirmationDialog(true)
              }}
            />
          ))}
      </span>
    )
  }
  // , [activeButton, studies, researcherId, props.sharedstudies])

  const handleVersioning = async (status) => {
    try {
      if (status === "Yes") {
        const updatedActivity = { ...dialogActivity, versionThis: true }
        await handleUpdateActivity(dialogActivity.id, updatedActivity)
        enqueueSnackbar(t("Successfully versioned the activity."), { variant: "success", autoHideDuration: 2000 })
      } else {
        setConfirmationVersionDialog(false)
      }
    } catch {
      enqueueSnackbar(t("Error in versioning the activity."), { variant: "error", autoHideDuration: 2000 })
      console.log(`Activity ID ${dialogActivity.id} failed for versioning ${dialogActivity}`)
    } finally {
      setConfirmationVersionDialog(false)
      setActiveButton({ id: null, action: null })
    }
  }

  const handleRestoreVersion = async (version, activity) => {
    try {
      const updatedActivity = {
        ...activity,
        settings: version.details?.settings,
        name: version.details?.name,
      }
      await handleUpdateActivity(activity.id, updatedActivity)
      enqueueSnackbar(t("Version restored successfully"), { variant: "success" })
      setVersionHistoryOpen(false)
    } catch (error) {
      console.error("Error restoring version:", error)
      enqueueSnackbar(t("Failed to restore version"), { variant: "error" })
    } finally {
      setVersionHistoryOpen(false)
      setActiveButton({ id: null, action: null })
    }
  }

  const handlePreviewVersion = async (version, activity) => {
    try {
      setPreviewDialogOpen(true)
      setSelectedVersion(version)
    } catch (error) {
      console.error("Error previewing version:", error)
      enqueueSnackbar(t("Failed to preview version"), { variant: "error" })
    }
  }

  const confirmShareActivity = async (val: string, activity) => {
    try {
      if (val == "Yes") {
        console.log("Sharing activity with community:", activity)
        const updatedActivity = {
          ...activity,
          shareTocommunity: !activity.shareTocommunity,
        }

        await handleUpdateActivity(activity.id, updatedActivity)
        setShareDialogOpen(false)
        setActiveButton({ id: null, action: null })
        enqueueSnackbar(t("Activity published in community successfully"), {
          variant: "success",
          autoHideDuration: 1000,
        })
      }
    } catch (error) {
      console.error("Error sharing activity:", error)
      enqueueSnackbar(t("Failed to publish activity in community."), { variant: "error" })
    } finally {
      setShareDialogOpen(false)
      setActiveButton({ id: null, action: null })
    }
  }

  const handleDuplicateActivity = async (activity) => {
    if (!selectedStudyForDuplicate) {
      enqueueSnackbar(t("Please select a study"), { variant: "error" })
      return
    }

    setDuplicateLoading(true)
    try {
      const newActivity = {
        ...activity,
        name: `${activity.name} (Copy)`,
        spec: activity.spec,
        settings: activity.settings,
        schedule: [],
        category: activity.category,
        sharingStudies: [],
        scoreInterpretation: activity.scoreInterpretation || {},
        activityGuide: activity.activityGuide || null,
        versionHistory: [],
        shareTocommunity: false,
        currentVersion: null,
      }
      const newActivityId = await LAMP.Activity.create(selectedStudyForDuplicate, newActivity)
      await Service.addData("activities", [
        {
          id: newActivityId,
          ...newActivity,
          study_id: selectedStudyForDuplicate,
        },
      ])
      setDuplicateDialogOpen(false)
      searchActivities()
      enqueueSnackbar(t("Activity duplicated successfully"), { variant: "success" })
    } catch (error) {
      console.error("Error duplicating activity:", error)
      enqueueSnackbar(t("Failed to duplicate activity"), { variant: "error" })
    } finally {
      setDuplicateLoading(false)
      setActiveButton({ id: null, action: null })
    }
  }

  const handleDeleteActivity = async (status) => {
    if (status === "Yes") {
      try {
        if (dialogActivity.spec === "lamp.survey") {
          await LAMP.Type.setAttachment(dialogActivity.id, "me", "lamp.dashboard.survey_description", null)
        } else {
          await LAMP.Type.setAttachment(dialogActivity.id, "me", "emersive.activity.details", null)
        }
        await LAMP.Activity.delete(dialogActivity.id)
        await Service.delete("activities", [dialogActivity.id])
        await Service.updateCount("studies", dialogActivity.study_id, "activity_count", 1, 1)
        setActivities((prev) => prev.filter((a) => a.id !== dialogActivity.id))
        await searchActivities()
        enqueueSnackbar(t("Activity deleted successfully"), { variant: "success" })
      } catch (error) {
        console.error("Error deleting activity:", error)
        enqueueSnackbar(t("Failed to delete activity"), { variant: "error" })
      }
    } else {
      setConfirmationDialog(false)
    }
    setConfirmationDialog(false)
    setActiveButton({ id: null, action: null })
  }

  useEffect(() => {
    console.warn("Active button changed:", activeButton)
  }, [activeButton])

  useEffect(() => {
    console.warn("editingActivity changed:", editingActivity)
  }, [editingActivity])

  // const [columns, setColumns] = useState<TableColumn[]>([
  const columngenerator = useCallback(
    () => [
      {
        id: "id",
        label: "ID",
        key: `id-${editingActivity?.id || "view"}-${rowMode}`,
        value: (a) => a.id,
        visible: true,
        sortable: false,
        filterable: true,
        filterType: "text",
        filterPlaceholder: "Filter by ID",
        renderCell: (activity) => (
          <Box
            className={classes.copyableCell}
            onClick={() => {
              window.navigator?.clipboard?.writeText?.(activity.id)
              enqueueSnackbar("ID copied to clipboard", {
                variant: "success",
                autoHideDuration: 1000,
              })
            }}
          >
            {activity.id}
          </Box>
        ),
      },
      {
        id: "name",
        label: "Name",
        key: `name-${editingActivity?.id || "view"}-${rowMode}`,
        value: (a) => a.name,
        visible: true,
        sortable: true,
        filterable: true,
        filterType: "text",
        filterPlaceholder: "Filter by Name",
        renderCell: (activity) => {
          if (rowMode === "edit" && editingActivity?.id === activity.id) {
            return (
              <TextField
                value={editedValues.name ?? activity.name}
                onChange={(e) => handleCellValueChange(activity.id, "name", e.target.value)}
                fullWidth
                size="small"
                variant="outlined"
                className={classes.editableField}
              />
            )
          }
          console.warn(
            "rendercell inside activity loist",
            activity.name,
            " Mode : " + rowMode + " Editing Activity: " + editingActivity
          )
          return activity.name
        },
      },
      {
        id: "spec",
        label: "Spec",
        value: (a) => a.spec,
        visible: true,
        sortable: true,
        filterable: true,
        filterField: "spec",
        filterType: "dropdown",
        filterOptions: availableActivitySpecs.map((spec) => ({
          label: spec.replace("lamp.", ""),
          value: spec,
        })),
        renderCell: (a) => a.spec,
      },
      {
        id: "creator",
        label: "Creator",
        value: (a) => a.creator,
        visible: true,
        sortable: true,
        filterable: true,
        filterType: "text",
        filterPlaceholder: "Filter by Creator",
        renderCell: (activity) => {
          const creator = allresearchers.find((r) => r.id === activity.creator)?.name || activity.creator
          return (
            <Box
              className={classes.copyableCell}
              onClick={() => {
                window.navigator?.clipboard?.writeText?.(creator)
                enqueueSnackbar("Creator copied to clipboard", {
                  variant: "success",
                  autoHideDuration: 1000,
                })
              }}
            >
              {creator}
            </Box>
          )
        },
      },
      {
        id: "createdAt",
        label: "Created At",
        value: (a) => formatDate(a.createdAt),
        visible: true,
        sortable: true,
        filterable: true,
        filterType: "date",
        filterPlaceholder: "Filter by Date",
        renderCell: (activity) => formatDate(activity.createdAt),
      },
      {
        id: "version",
        label: "Version",
        value: (a) => a.currentVersion?.name || "v1",
        visible: true,
        sortable: false,
        renderCell: (activity) => (
          <Box className={classes.versionBadge}>
            <Icon fontSize="small">flag</Icon>
            {activity.currentVersion?.name || "v1.0"}
          </Box>
        ),
      },
      // { id: 'schedule', label: 'Schedule',
      //   value: (a) => formatSchedule(a.schedule),
      //   visible: true
      // },
      {
        id: "groups",
        label: "Groups",
        key: `groups-${editingActivity?.id || "view"}-${rowMode}`,
        value: (a) => a.groups || [],
        visible: true,
        sortable: false,
        renderCell: (activity) => {
          if (rowMode === "edit" && editingActivity?.id === activity.id) {
            const availableGroups = activity.study_id
              ? studies.find((s) => s.id === activity.study_id)?.gname || []
              : []
            return (
              <FormControl fullWidth size="small" variant="outlined">
                <Select
                  multiple
                  value={editedValues.groups ?? activity.groups ?? []}
                  onChange={(e) => handleCellValueChange(activity.id, "groups", e.target.value)}
                  renderValue={(selected: string[]) => (
                    <Box style={{ display: "flex", flexWrap: "wrap", gap: 0.5 }}>
                      {selected.map((value) => (
                        <Chip key={value} label={value} size="small" />
                      ))}
                    </Box>
                  )}
                  className={classes.editableField}
                >
                  {availableGroups.map((group) => (
                    <MenuItem key={group} value={group}>
                      <Checkbox checked={(editedValues.groups ?? activity.groups ?? []).includes(group)} />
                      <ListItemText primary={group} />
                    </MenuItem>
                  ))}
                </Select>
              </FormControl>
            )
          }
          return (
            <Box style={{ display: "flex", flexWrap: "wrap", gap: 0.5 }}>
              {(activity.groups || []).map((group) => (
                <Chip key={group} label={group} size="small" />
              ))}
            </Box>
          )
        },
      },
      {
        id: "study",
        label: "Study",
        value: (a) => ({
          name: a.study_name,
          id: a.study_id,
        }),
        visible: true,
        sortable: true,
        filterable: true,
        filterType: "text",
        filterPlaceholder: "Filter by Study",
        renderCell: (activity) => (
          <Box
            className={classes.studyCell}
            onClick={() => {
              window.navigator?.clipboard?.writeText?.(activity.study_id)
              enqueueSnackbar("Study ID copied to clipboard", {
                variant: "success",
                autoHideDuration: 1000,
              })
            }}
          >
            {activity.study_name || "No Study Name"}
          </Box>
        ),
      },
      {
        id: "ownership",
        label: "Ownership",
        // value: (a) => a.isShared ? `Shared` : "Owner",
        value: (a) => getParentResearcher(a.parentResearcher) || getParentResearcher(researcherId),
        visible: true,
        sortable: true,
        filterable: true,
        filterType: "text",
        filterPlaceholder: "Filter by Owner",
        renderCell: (activity) => getParentResearcher(activity.parentResearcher) || getParentResearcher(researcherId),
      },
      // { id: 'studyId', label: 'Study', value: (a) => a.study_id, visible: true },
      {
        id: "device",
        label: "Device",
        value: (a) => a.device || "-",
        visible: false,
        sortable: true,
        renderCell: (a) => a.device || "-",
        key: `device-${editingActivity?.id || "view"}-${rowMode}`,
      },
      // { id:"tableV", label:"Table Version", value: editingActivity ? `${editingActivity.id}-${rowMode}` : null, visible: false, sortable: false},
    ],
    [rowMode, editingActivity, allresearchers, activeButton]
  )
  const [columns, setColumns] = useState<TableColumn[]>([])

  useEffect(() => {
    const cols = [...columngenerator()] as TableColumn[]
    console.warn("cols being generated", cols)
    setColumns(cols)
  }, [columngenerator, editingActivity, rowMode]) //

  // Memoize columns for DataTable to ensure new reference on columns update
  const columnsTable = useMemo(() => {
    console.warn("New columns for Datatable")
    return [...columns]
  }, [columns, editingActivity, rowMode]) // editingActivity, rowMode

  const handleViewActivity = (activity) => {
    if (!canViewActivity(activity, studies, researcherId, props.sharedstudies)) {
      enqueueSnackbar(t("You don't have permission to view this activity"), { variant: "error" })
      return
    }
    setViewingActivity(activity)
    setIsEditing(false)
    setTriggerSave(false)
  }

  const handleCloseViewActivity = () => {
    setViewingActivity(null)
    setIsEditing(false)
    setTriggerSave(false)
    // setActiveButton({ id: null, action: null }); TODO
  }

  const handleEditActivity = () => {
    if (!viewingActivity || !canEditActivity(viewingActivity, studies, researcherId, props.sharedstudies)) {
      enqueueSnackbar(t("You don't have permission to edit this activity"), { variant: "error" })
      return
    }

    if (isEditing) {
      setIsEditing(false)
    } else {
      setIsEditing(true)
      setTriggerSave(false)
    }
  }

  const handleSaveActivity = () => {
    if (!viewingActivity || !canEditActivity(viewingActivity, studies, researcherId, props.sharedstudies)) {
      enqueueSnackbar(t("You don't have permission to save changes to this activity"), { variant: "error" })
      return
    }

    setTriggerSave(true)
  }

  const handleEditActivityTable = (activity: any) => {
    // const handleEditActivityTable = (activity: any) => {
    console.warn("Editing activity in table:", activity?.id, editingActivity?.id, rowMode, activeButton)
    if (!canEditActivity(activity, studies, researcherId, props.sharedstudies)) {
      enqueueSnackbar(t("You don't have permission to edit this activity"), { variant: "error" })
      return
    }

    if (editingActivity?.id === activity.id) {
      // Cancel edit mode
      setRowMode("view")
      setEditingActivity(null)
      setEditedValues({})
      setActiveButton({ id: null, action: null })
      console.warn("Canceling edit mode for:", activity?.id, editingActivity?.id, rowMode, activeButton)
    } else {
      // Start editing
      setEditingActivity(activity)
      setRowMode("edit")
      setEditedValues({
        name: activity.name,
        groups: activity.groups || [],
      })
      setActiveButton({ id: activity.id, action: "edit" })
      console.warn("Starting edit mode for:", activity?.id, editingActivity?.id, rowMode, activeButton)
    }
  }
  const handleSaveActivityTable = async (activity: any) => {
    if (Object.keys(editedValues).length > 0) {
      try {
        const updatedActivity = {
          ...activity,
          ...editedValues,
        }
        await handleUpdateActivity(activity.id, updatedActivity)
        setEditingActivity(null)
        setEditedValues({})
        setRowMode("view")
        setActiveButton({ id: null, action: null })
        enqueueSnackbar(t("Activity updated successfully"), { variant: "success" })
      } catch (error) {
        console.error("Error updating activity:", error)
        enqueueSnackbar(t("Failed to update activity"), { variant: "error" })
      }
    } else {
      enqueueSnackbar(t("No changes to save"), { variant: "info" })
      setEditingActivity(null)
      setRowMode("view")
      setActiveButton({ id: null, action: null })
    }
  }

  const handleSaveComplete = (updatedActivity) => {
    console.log("Save complete:", updatedActivity)
    setViewingActivity(updatedActivity)
    setIsEditing(false)
    setTriggerSave(false)
    searchActivities()
  }


  const categorizeActivities = (activities) => {
    return {
      // Shared: activities.filter((a) => a.isShared),
      Custom: activities.filter((a) => !a.isCommunityActivity),
      Community: activities.filter((a) => a.isCommunityActivity),
      Core: activities.filter((a) => !a.isCommunityActivity && a.category === "core"),
    }
  }

  const initFilters = () => {
    const baseFilters = {
      global: { value: null, matchMode: FilterMatchMode.CONTAINS },
    }
    columns.forEach((col) => {
      baseFilters[col.id] = { value: null, matchMode: FilterMatchMode.CONTAINS }
    })
    return baseFilters
  }
  const [filters, setFilters] = useState(initFilters())

  useEffect(() => {
    setFilters(initFilters())
  }, [columns])

  const originalIndexMap = useMemo(() => {
    return [...(activities || []), ...(communityActivities || [])].reduce((acc, activity, index) => {
      acc[activity.id] = index
      return acc
    }, {})
  }, [activities, communityActivities])

  useEffect(() => {
    if (filterParam) {
      console.log("Filter param changed:", filterParam)
      setSearch(null)
      searchActivities()
    }
  }, [filterParam])
  return (
    <React.Fragment>
      <Backdrop className={classes.backdrop} open={loading || activities === null}>
        <CircularProgress color="inherit" />
      </Backdrop>
      {viewingActivity ? (
        <Header
          authType={LAMP.Auth._type}
          title={props.ptitle}
          pageLocation={`${props.ptitle} > Activities > ${viewingActivity.name}`}
        />
      ) : (

        <Header authType={LAMP.Auth._type} title={props.ptitle} pageLocation={`${props.ptitle} > Activities`} />

      )}
      {viewingActivity ? (
        <div className="body-container">
          <ActionsComponent
            actions={["edit", "save", "left", "right", "cancel"]}
            onEdit={handleEditActivity}
            onSave={handleSaveActivity}
            onPrevious={() => {
              const allActivitiesList = [...activities, ...communityActivities]
              const currentIndex = allActivitiesList.findIndex((a) => a.id === viewingActivity.id)
              if (currentIndex > 0) {
                setViewingActivity(allActivitiesList[currentIndex - 1])
              }
            }}
            onNext={() => {
              const allActivitiesList = [...activities, ...communityActivities]
              const currentIndex = allActivitiesList.findIndex((a) => a.id === viewingActivity.id)
              if (currentIndex < allActivitiesList.length - 1) {
                setViewingActivity(allActivitiesList[currentIndex + 1])
              }
            }}
            onClose={handleCloseViewActivity}
            disabledBtns={
              viewingActivity.isCommunityActivity ||
              !canEditActivity(viewingActivity, studies, researcherId, props.sharedstudies)
            }
          />
          <ActivityDetailItem
            activity={viewingActivity}
            isEditing={isEditing}
            onSave={handleSaveComplete}
            studies={studies}
            triggerSave={triggerSave}
          />
        </div>
      ) : creatingActivity ? (
        <CreateActivity
          studies={studies}
          selectedSpec={selectedSpec}
          researcherId={researcherId}
          onSave={(newActivity) => {
            setActivities((prev) => [...prev, newActivity])
            searchActivities()
            setCreatingActivity(false)
          }}
          onCancel={() => setCreatingActivity(false)}
          sharedstudies={props.sharedstudies}
        />
      ) : (
        <div className="body-container">
          <ActionsComponent
            searchData={handleSearchData}
            refreshElements={searchActivities}
            setSelectedColumns={setColumns}
            VisibleColumns={columns}
            setVisibleColumns={setColumns}
            addComponent={
              <AddActivity
                activities={activities}
                studies={studies}
                studyId={null}
                setActivities={setActivities}
                researcherId={researcherId}
                showCreateForm={creatingActivity}
                setShowCreateForm={setCreatingActivity}
                setSelectedSpec={setSelectedSpec}
              />
            }
            actions={["refresh", "search", "grid", "table", "filter", "download"]}
            tabularView={tabularView}
            setTabularView={setTabularView}
            studies={studies}
            selectedStudies={selectedStudies}
            setSelectedStudies={setSelectedStudies}
            researcherId={researcherId}
            order={order}
            setOrder={setOrder}
            tabType={"activities"}
            downloadTarget={"activities"}
          />
          {!tabularView ? (
            <div className="" style={{ overflow: "auto" }}>
              <Grid container spacing={3} className="cards-grid">
                {!!activities && activities.length > 0 ? (
                  <>
                    {paginatedActivities.map((activity) => (
                      <Grid item xs={12} sm={12} md={6} lg={4} key={activity.id}>
                        <ActivityItem
                          activity={activity}
                          researcherId={researcherId}
                          studies={studies}
                          activities={activities}
                          handleSelectionChange={handleChange}
                          selectedActivities={selectedActivities}
                          setActivities={searchActivities}
                          updateActivities={setActivities}
                          sharedstudies={props.sharedstudies}
                          onActivityUpdate={handleUpdateActivity}
                          formatDate={formatDate}
                          searchActivities={searchActivities}
                          onViewActivity={handleViewActivity}
                          allresearchers={allresearchers}
                        />
                      </Grid>
                    ))}
                    <Pagination
                      data={[...activities, ...communityActivities]}
                      updatePage={handleChangePage}
                      rowPerPage={[20, 40, 60, 80]}
                      currentPage={page}
                      currentRowCount={rowCount}
                    />
                  </>
                ) : (
                  <Box className={classes.norecordsmain}>
                    <Box display="flex" p={2} alignItems="center" className={classes.norecords}>
                      <Icon>info</Icon>
                      {`${t("No Records Found")}`}
                    </Box>
                  </Box>
                )}
              </Grid>
            </div>
          ) : (
            <>
              <CommonTable
                data={[...activities, ...communityActivities]}
                columns={columnsTable}
                actions={activityActions}
                indexmap={originalIndexMap}
                sortConfig={sortConfig}
                onSort={(field) => {
                  setSortConfig({
                    field,
                    direction: sortConfig.field === field && sortConfig.direction === "asc" ? "desc" : "asc",
                  })
                }}
                categorizeItems={categorizeActivities}
                showCategoryHeaders={true}
                filters={filters}
                onFilter={(newFilters) => setFilters(newFilters)}
                filterDisplay="row"
                key={editingActivity ? `${editingActivity.id}-${rowMode}` : null}
                dataKeyprop={"name"}
              />
            </>
          )}
        </div>
      )}
    </React.Fragment>
  )
}
